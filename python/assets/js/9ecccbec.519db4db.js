"use strict";(self.webpackChunkplaywright_dev=self.webpackChunkplaywright_dev||[]).push([[6752],{9877:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>h,toc:()=>c});var n=a(4848),s=a(8453),i=a(4235),r=a(8328);a(3078);const o={id:"mock",title:"Mock APIs"},l=void 0,h={id:"mock",title:"Mock APIs",description:"Introduction",source:"@site/docs/mock.mdx",sourceDirName:".",slug:"/mock",permalink:"/python/docs/next/mock",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{id:"mock",title:"Mock APIs"},sidebar:"docs",previous:{title:"Locators",permalink:"/python/docs/next/locators"},next:{title:"Navigations",permalink:"/python/docs/next/navigations"}},d={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Mock API requests",id:"mock-api-requests",level:2},{value:"Modify API responses",id:"modify-api-responses",level:2},{value:"Mocking with HAR files",id:"mocking-with-har-files",level:2},{value:"Recording a HAR file",id:"recording-a-har-file",level:3},{value:"Modifying a HAR file",id:"modifying-a-har-file",level:3},{value:"Replaying from HAR",id:"replaying-from-har",level:3},{value:"Recording HAR with CLI",id:"recording-har-with-cli",level:4}];function p(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,n.jsxs)(t.p,{children:["Web APIs are usually implemented as HTTP endpoints. Playwright provides APIs to ",(0,n.jsx)(t.strong,{children:"mock"})," and ",(0,n.jsx)(t.strong,{children:"modify"})," network traffic, both HTTP and HTTPS. Any requests that a page does, including ",(0,n.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest",children:"XHRs"})," and ",(0,n.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API",children:"fetch"})," requests, can be tracked, modified and mocked. With Playwright you can also mock using HAR files that contain multiple network requests made by the page."]}),"\n",(0,n.jsx)(t.h2,{id:"mock-api-requests",children:"Mock API requests"}),"\n",(0,n.jsxs)(t.p,{children:["The following code will intercept all the calls to ",(0,n.jsx)(t.code,{children:"*/**/api/v1/fruits"})," and will return a custom response instead. No requests to the API will be made. The test goes to the URL that uses the mocked route and asserts that mock data is present on the page."]}),"\n",(0,n.jsxs)(i.A,{groupId:"python-flavor",defaultValue:"sync",values:[{label:"Sync",value:"sync"},{label:"Async",value:"async"}],children:[(0,n.jsx)(r.A,{value:"sync",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-py",children:'def test_mock_the_fruit_api(page: Page):\n    def handle(route: Route):\n        json = [{"name": "Strawberry", "id": 21}]\n        # fulfill the route with the mock data\n        route.fulfill(json=json)\n\n    # Intercept the route to the fruit API\n    page.route("*/**/api/v1/fruits", handle)\n\n    # Go to the page\n    page.goto("https://demo.playwright.dev/api-mocking")\n\n    # Assert that the Strawberry fruit is visible\n    expect(page.get_by_text("Strawberry")).to_be_visible()\n'})})}),(0,n.jsx)(r.A,{value:"async",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-py",children:'async def test_mock_the_fruit_api(page: Page):\n    async def handle(route: Route):\n        json = [{"name": "Strawberry", "id": 21}]\n        # fulfill the route with the mock data\n        await route.fulfill(json=json)\n\n    # Intercept the route to the fruit API\n    await page.route("*/**/api/v1/fruits", handle)\n\n    # Go to the page\n    await page.goto("https://demo.playwright.dev/api-mocking")\n\n    # Assert that the Strawberry fruit is visible\n    await expect(page.get_by_text("Strawberry")).to_be_visible()\n'})})})]}),"\n",(0,n.jsxs)(t.p,{children:["You can see from the trace of the example test that the API was never called, it was however fulfilled with the mock data. ",(0,n.jsx)(t.img,{src:"https://github.com/microsoft/playwright/assets/13063165/3dc14cbf-c100-4efc-ac21-d7b52d698b53",alt:"api mocking trace"})]}),"\n",(0,n.jsxs)(t.p,{children:["Read more about ",(0,n.jsx)(t.a,{href:"/python/docs/next/network",children:"advanced networking"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"modify-api-responses",children:"Modify API responses"}),"\n",(0,n.jsx)(t.p,{children:"Sometimes, it is essential to make an API request, but the response needs to be patched to allow for reproducible testing. In that case, instead of mocking the request, one can perform the request and fulfill it with the modified response."}),"\n",(0,n.jsx)(t.p,{children:"In the example below we intercept the call to the fruit API and add a new fruit called 'Loquat', to the data. We then go to the url and assert that this data is there:"}),"\n",(0,n.jsxs)(i.A,{groupId:"python-flavor",defaultValue:"sync",values:[{label:"Sync",value:"sync"},{label:"Async",value:"async"}],children:[(0,n.jsx)(r.A,{value:"sync",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-py",children:'def test_gets_the_json_from_api_and_adds_a_new_fruit(page: Page):\n    def handle(route: Route):\n        response = route.fetch()\n        json = response.json()\n        json.append({ "name": "Loquat", "id": 100})\n        # Fulfill using the original response, while patching the response body\n        # with the given JSON object.\n        route.fulfill(response=response, json=json)\n\n    page.route("https://demo.playwright.dev/api-mocking/api/v1/fruits", handle)\n\n    # Go to the page\n    page.goto("https://demo.playwright.dev/api-mocking")\n\n    # Assert that the new fruit is visible\n    expect(page.get_by_text("Loquat", exact=True)).to_be_visible()\n'})})}),(0,n.jsx)(r.A,{value:"async",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-py",children:'async def test_gets_the_json_from_api_and_adds_a_new_fruit(page: Page):\n    async def handle(route: Route):\n        response = await route.fetch()\n        json = await response.json()\n        json.append({ "name": "Loquat", "id": 100})\n        # Fulfill using the original response, while patching the response body\n        # with the given JSON object.\n        await route.fulfill(response=response, json=json)\n\n    await page.route("https://demo.playwright.dev/api-mocking/api/v1/fruits", handle)\n\n    # Go to the page\n    await page.goto("https://demo.playwright.dev/api-mocking")\n\n    # Assert that the new fruit is visible\n    await expect(page.get_by_text("Loquat", exact=True)).to_be_visible()\n'})})})]}),"\n",(0,n.jsxs)(t.p,{children:["In the trace of our test we can see that the API was called and the response was modified. ",(0,n.jsx)(t.img,{src:"https://github.com/microsoft/playwright/assets/13063165/8b8dd82d-1b3e-428e-871b-840581fed439",alt:"trace of test showing api being called and fulfilled"})]}),"\n",(0,n.jsxs)(t.p,{children:["By inspecting the response we can see that our new fruit was added to the list. ",(0,n.jsx)(t.img,{src:"https://github.com/microsoft/playwright/assets/13063165/03e6c87c-4ecc-47e8-9ca0-30fface25e9d",alt:"trace of test showing the mock response"})]}),"\n",(0,n.jsxs)(t.p,{children:["Read more about ",(0,n.jsx)(t.a,{href:"/python/docs/next/network",children:"advanced networking"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"mocking-with-har-files",children:"Mocking with HAR files"}),"\n",(0,n.jsxs)(t.p,{children:["A HAR file is an ",(0,n.jsx)(t.a,{href:"http://www.softwareishard.com/blog/har-12-spec/",children:"HTTP Archive"})," file that contains a record of all the network requests that are made when a page is loaded. It contains information about the request and response headers, cookies, content, timings, and more. You can use HAR files to mock network requests in your tests. You'll need to:"]}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsx)(t.li,{children:"Record a HAR file."}),"\n",(0,n.jsx)(t.li,{children:"Commit the HAR file alongside the tests."}),"\n",(0,n.jsx)(t.li,{children:"Route requests using the saved HAR files in the tests."}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"recording-a-har-file",children:"Recording a HAR file"}),"\n",(0,n.jsxs)(t.p,{children:["To record a HAR file we use ",(0,n.jsx)(t.a,{href:"/python/docs/next/api/class-page#page-route-from-har",children:"page.route_from_har()"})," or ",(0,n.jsx)(t.a,{href:"/python/docs/next/api/class-browsercontext#browser-context-route-from-har",children:"browser_context.route_from_har()"})," method. This method takes in the path to the HAR file and an optional object of options. The options object can contain the URL so that only requests with the URL matching the specified glob pattern will be served from the HAR File. If not specified, all requests will be served from the HAR file."]}),"\n",(0,n.jsxs)(t.p,{children:["Setting ",(0,n.jsx)(t.code,{children:"update"})," option to true will create or update the HAR file with the actual network information instead of serving the requests from the HAR file. Use it when creating a test to populate the HAR with real data."]}),"\n",(0,n.jsxs)(i.A,{groupId:"python-flavor",defaultValue:"sync",values:[{label:"Sync",value:"sync"},{label:"Async",value:"async"}],children:[(0,n.jsx)(r.A,{value:"sync",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-py",children:'def test_records_or_updates_the_har_file(page: Page):\n    # Get the response from the HAR file\n    page.route_from_har("./hars/fruit.har", url="*/**/api/v1/fruits", update=True)\n\n    # Go to the page\n    page.goto("https://demo.playwright.dev/api-mocking")\n\n    # Assert that the fruit is visible\n    expect(page.get_by_text("Strawberry")).to_be_visible()\n'})})}),(0,n.jsx)(r.A,{value:"async",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-py",children:'async def test_records_or_updates_the_har_file(page: Page):\n    # Get the response from the HAR file\n    await page.route_from_har("./hars/fruit.har", url="*/**/api/v1/fruits", update=True)\n\n    # Go to the page\n    await page.goto("https://demo.playwright.dev/api-mocking")\n\n    # Assert that the fruit is visible\n    await expect(page.get_by_text("Strawberry")).to_be_visible()\n'})})})]}),"\n",(0,n.jsx)(t.h3,{id:"modifying-a-har-file",children:"Modifying a HAR file"}),"\n",(0,n.jsxs)(t.p,{children:["Once you have recorded a HAR file you can modify it by opening the hashed .txt file inside your 'hars' folder and editing the JSON. This file should be committed to your source control. Anytime you run this test with ",(0,n.jsx)(t.code,{children:"update: true"})," it will update your HAR file with the request from the API."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'[\n  {\n    "name": "Playwright",\n    "id": 100\n  },\n  // ... other fruits\n]\n'})}),"\n",(0,n.jsx)(t.h3,{id:"replaying-from-har",children:"Replaying from HAR"}),"\n",(0,n.jsxs)(t.p,{children:["Now that you have the HAR file recorded and modified the mock data, it can be used to serve matching responses in the test. For this, just turn off or simply remove the ",(0,n.jsx)(t.code,{children:"update"})," option. This will run the test against the HAR file instead of hitting the API."]}),"\n",(0,n.jsxs)(i.A,{groupId:"python-flavor",defaultValue:"sync",values:[{label:"Sync",value:"sync"},{label:"Async",value:"async"}],children:[(0,n.jsx)(r.A,{value:"sync",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-py",children:'def test_gets_the_json_from_har_and_checks_the_new_fruit_has_been_added(page: Page):\n    # Replay API requests from HAR.\n    # Either use a matching response from the HAR,\n    # or abort the request if nothing matches.\n    page.route_from_har("./hars/fruit.har", url="*/**/api/v1/fruits", update=False)\n\n    # Go to the page\n    page.goto("https://demo.playwright.dev/api-mocking")\n\n    # Assert that the Playwright fruit is visible\n    expect(page.get_by_text("Playwright", exact=True)).to_be_visible()\n'})})}),(0,n.jsx)(r.A,{value:"async",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-py",children:'async def test_gets_the_json_from_har_and_checks_the_new_fruit_has_been_added(page: Page):\n    # Replay API requests from HAR.\n    # Either use a matching response from the HAR,\n    # or abort the request if nothing matches.\n    await page.route_from_har("./hars/fruit.har", url="*/**/api/v1/fruits", update=False)\n\n    # Go to the page\n    await page.goto("https://demo.playwright.dev/api-mocking")\n\n    # Assert that the Playwright fruit is visible\n    await expect(page.get_by_text("Playwright", exact=True)).to_be_visible()\n'})})})]}),"\n",(0,n.jsxs)(t.p,{children:["In the trace of our test we can see that the route was fulfilled from the HAR file and the API was not called. ",(0,n.jsx)(t.img,{src:"https://github.com/microsoft/playwright/assets/13063165/1bd7ab66-ea4f-43c2-a4e5-ca17d4837ff1",alt:"trace showing the HAR file being used"})]}),"\n",(0,n.jsxs)(t.p,{children:["If we inspect the response we can see our new fruit was added to the JSON, which was done by manually updating the hashed ",(0,n.jsx)(t.code,{children:".txt"})," file inside the ",(0,n.jsx)(t.code,{children:"hars"})," folder. ",(0,n.jsx)(t.img,{src:"https://github.com/microsoft/playwright/assets/13063165/db3117fc-7b02-4973-9a51-29e213261a6a",alt:"trace showing response from HAR file"})]}),"\n",(0,n.jsx)(t.p,{children:"HAR replay matches URL and HTTP method strictly. For POST requests, it also matches POST payloads strictly. If multiple recordings match a request, the one with the most matching headers is picked. An entry resulting in a redirect will be followed automatically."}),"\n",(0,n.jsxs)(t.p,{children:["Similar to when recording, if given HAR file name ends with ",(0,n.jsx)(t.code,{children:".zip"}),", it is considered an archive containing the HAR file along with network payloads stored as separate entries. You can also extract this archive, edit payloads or HAR log manually and point to the extracted har file. All the payloads will be resolved relative to the extracted har file on the file system."]}),"\n",(0,n.jsx)(t.h4,{id:"recording-har-with-cli",children:"Recording HAR with CLI"}),"\n",(0,n.jsxs)(t.p,{children:["We recommend the ",(0,n.jsx)(t.code,{children:"update"})," option to record HAR file for your test. However, you can also record the HAR with Playwright CLI."]}),"\n",(0,n.jsxs)(t.p,{children:["Open the browser with Playwright CLI and pass ",(0,n.jsx)(t.code,{children:"--save-har"})," option to produce a HAR file. Optionally, use ",(0,n.jsx)(t.code,{children:"--save-har-glob"})," to only save requests you are interested in, for example API endpoints. If the har file name ends with ",(0,n.jsx)(t.code,{children:".zip"}),", artifacts are written as separate files and are all compressed into a single ",(0,n.jsx)(t.code,{children:"zip"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'# Save API requests from example.com as "example.har" archive.\nplaywright open --save-har=example.har --save-har-glob="**/api/**" https://example.com\n'})}),"\n",(0,n.jsxs)(t.p,{children:["Read more about ",(0,n.jsx)(t.a,{href:"/python/docs/next/network",children:"advanced networking"}),"."]})]})}function u(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(p,{...e})}):p(e)}}}]);