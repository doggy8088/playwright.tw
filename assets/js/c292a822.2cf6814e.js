"use strict";(self.webpackChunkplaywright_dev=self.webpackChunkplaywright_dev||[]).push([[3746],{6594:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>g,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var n=a(4848),r=a(8453);a(4235),a(8328),a(3078);const i={id:"mock-browser-apis",title:"Mock browser APIs"},o=void 0,s={id:"mock-browser-apis",title:"Mock browser APIs",description:"Introduction",source:"@site/docs/mock-browser.mdx",sourceDirName:".",slug:"/mock-browser-apis",permalink:"/docs/next/mock-browser-apis",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{id:"mock-browser-apis",title:"Mock browser APIs"},sidebar:"docs",previous:{title:"Mock APIs",permalink:"/docs/next/mock"},next:{title:"Navigations",permalink:"/docs/next/navigations"}},c={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Introduction",id:"introduction-1",level:2},{value:"Creating mocks",id:"creating-mocks",level:2},{value:"Mocking read-only APIs",id:"mocking-read-only-apis",level:2},{value:"Verifying API calls",id:"verifying-api-calls",level:2},{value:"Updating mock",id:"updating-mock",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,n.jsx)(t.p,{children:"Playwright provides native support for most of the browser features. However, there are some experimental APIs and APIs which are not (yet) fully supported by all browsers. Playwright usually doesn't provide dedicated automation APIs in such cases. You can use mocks to test the behavior of your application in such cases. This guide gives a few examples."}),"\n",(0,n.jsx)(t.h2,{id:"introduction-1",children:"Introduction"}),"\n",(0,n.jsxs)(t.p,{children:["Let's consider a web app that uses ",(0,n.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/API/Navigator/getBattery",children:"battery API"})," to show your device's battery status. We'll mock the battery API and check that the page correctly displays the battery status."]}),"\n",(0,n.jsx)(t.h2,{id:"creating-mocks",children:"Creating mocks"}),"\n",(0,n.jsxs)(t.p,{children:["Since the page may be calling the API very early while loading it's important to setup all the mocks before the page started loading. The easiest way to achieve that is to call ",(0,n.jsx)(t.a,{href:"/docs/next/api/class-page#page-add-init-script",children:"page.addInitScript()"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"await page.addInitScript(() => {\n  const mockBattery = {\n    level: 0.75,\n    charging: true,\n    chargingTime: 1800,\n    dischargingTime: Infinity,\n    addEventListener: () => { }\n  };\n  // Override the method to always return mock battery info.\n  window.navigator.getBattery = async () => mockBattery;\n});\n"})}),"\n",(0,n.jsx)(t.p,{children:"Once this is done you can navigate the page and check its UI state:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"// Configure mock API before each test.\ntest.beforeEach(async ({ page }) => {\n  await page.addInitScript(() => {\n    const mockBattery = {\n      level: 0.90,\n      charging: true,\n      chargingTime: 1800, // seconds\n      dischargingTime: Infinity,\n      addEventListener: () => { }\n    };\n    // Override the method to always return mock battery info.\n    window.navigator.getBattery = async () => mockBattery;\n  });\n});\n\ntest('show battery status', async ({ page }) => {\n  await page.goto('/');\n  await expect(page.locator('.battery-percentage')).toHaveText('90%');\n  await expect(page.locator('.battery-status')).toHaveText('Adapter');\n  await expect(page.locator('.battery-fully')).toHaveText('00:30');\n});\n\n"})}),"\n",(0,n.jsx)(t.h2,{id:"mocking-read-only-apis",children:"Mocking read-only APIs"}),"\n",(0,n.jsx)(t.p,{children:"Some APIs are read-only so you won't be able to assign to a navigator property. For example,"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"// Following line will have no effect.\nnavigator.cookieEnabled = true;\n"})}),"\n",(0,n.jsxs)(t.p,{children:["However, if the property is ",(0,n.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty#configurable",children:"configurable"}),", you can still override it using the plain JavaScript:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"await page.addInitScript(() => {\n  Object.defineProperty(Object.getPrototypeOf(navigator), 'cookieEnabled', { value: false });\n});\n"})}),"\n",(0,n.jsx)(t.h2,{id:"verifying-api-calls",children:"Verifying API calls"}),"\n",(0,n.jsxs)(t.p,{children:["Sometimes it is useful to check if the page made all expected APIs calls. You can record all API method invocations and then compare them with golden result. ",(0,n.jsx)(t.a,{href:"/docs/next/api/class-page#page-expose-function",children:"page.exposeFunction()"})," may come in handy for passing message from the page back to the test code:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"test('log battery calls', async ({ page }) => {\n  const log = [];\n  // Expose function for pushing messages to the Node.js script.\n  await page.exposeFunction('logCall', msg => log.push(msg));\n  await page.addInitScript(() => {\n    const mockBattery = {\n      level: 0.75,\n      charging: true,\n      chargingTime: 1800,\n      dischargingTime: Infinity,\n      // Log addEventListener calls.\n      addEventListener: (name, cb) => logCall(`addEventListener:${name}`)\n    };\n    // Override the method to always return mock battery info.\n    window.navigator.getBattery = async () => {\n      logCall('getBattery');\n      return mockBattery;\n    };\n  });\n\n  await page.goto('/');\n  await expect(page.locator('.battery-percentage')).toHaveText('75%');\n\n  // Compare actual calls with golden.\n  expect(log).toEqual([\n    'getBattery',\n    'addEventListener:chargingchange',\n    'addEventListener:levelchange'\n  ]);\n});\n"})}),"\n",(0,n.jsx)(t.h2,{id:"updating-mock",children:"Updating mock"}),"\n",(0,n.jsx)(t.p,{children:"To test that the app correctly reflects battery status updates it's important to make sure that the mock battery object fires same events that the browser implementation would. The following test demonstrates how to achieve that:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-js",children:"test('update battery status (no golden)', async ({ page }) => {\n  await page.addInitScript(() => {\n    // Mock class that will notify corresponding listeners when battery status changes.\n    class BatteryMock {\n      level = 0.10;\n      charging = false;\n      chargingTime = 1800;\n      dischargingTime = Infinity;\n      _chargingListeners = [];\n      _levelListeners = [];\n      addEventListener(eventName, listener) {\n        if (eventName === 'chargingchange')\n          this._chargingListeners.push(listener);\n        if (eventName === 'levelchange')\n          this._levelListeners.push(listener);\n      }\n      // Will be called by the test.\n      _setLevel(value) {\n        this.level = value;\n        this._levelListeners.forEach(cb => cb());\n      }\n      _setCharging(value) {\n        this.charging = value;\n        this._chargingListeners.forEach(cb => cb());\n      }\n    }\n    const mockBattery = new BatteryMock();\n    // Override the method to always return mock battery info.\n    window.navigator.getBattery = async () => mockBattery;\n    // Save the mock object on window for easier access.\n    window.mockBattery = mockBattery;\n  });\n\n  await page.goto('/');\n  await expect(page.locator('.battery-percentage')).toHaveText('10%');\n\n  // Update level to 27.5%\n  await page.evaluate(() => window.mockBattery._setLevel(0.275));\n  await expect(page.locator('.battery-percentage')).toHaveText('27.5%');\n  await expect(page.locator('.battery-status')).toHaveText('Battery');\n\n  // Emulate connected adapter\n  await page.evaluate(() => window.mockBattery._setCharging(true));\n  await expect(page.locator('.battery-status')).toHaveText('Adapter');\n  await expect(page.locator('.battery-fully')).toHaveText('00:30');\n});\n"})})]})}function g(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}}}]);