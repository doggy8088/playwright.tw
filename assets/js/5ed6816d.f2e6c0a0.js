"use strict";(self.webpackChunkplaywright_dev=self.webpackChunkplaywright_dev||[]).push([[9512],{9178:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>i,metadata:()=>a,toc:()=>h});var n=r(4848),s=r(8453);r(4235),r(8328),r(3078);const i={id:"test-sharding",title:"Sharding"},o=void 0,a={id:"test-sharding",title:"Sharding",description:"Introduction",source:"@site/docs/test-sharding.mdx",sourceDirName:".",slug:"/test-sharding",permalink:"/docs/next/test-sharding",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{id:"test-sharding",title:"Sharding"},sidebar:"docs",previous:{title:"Retries",permalink:"/docs/next/test-retries"},next:{title:"Timeouts",permalink:"/docs/next/test-timeouts"}},l={},h=[{value:"Introduction",id:"introduction",level:2},{value:"Sharding tests between multiple machines",id:"sharding-tests-between-multiple-machines",level:2},{value:"Merging reports from multiple shards",id:"merging-reports-from-multiple-shards",level:2},{value:"GitHub Actions example",id:"github-actions-example",level:2},{value:"Merge-reports CLI",id:"merge-reports-cli",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,n.jsxs)(t.p,{children:["By default, Playwright runs test files in ",(0,n.jsx)(t.a,{href:"/docs/next/test-parallel",children:"parallel"}),' and strives for optimal utilization of CPU cores on your machine. In order to achieve even greater parallelisation, you can further scale Playwright test execution by running tests on multiple machines simultaneously. We call this mode of operation "sharding". Sharding in Playwright means splitting your tests into smaller parts called "shards". Each shard is like a separate job that can run independently. The whole purpose is to divide your tests to speed up test runtime.']}),"\n",(0,n.jsx)(t.p,{children:"When you shard your tests, each shard can run on its own, utilizing the available CPU cores. This helps speed up the testing process by doing tasks simultaneously."}),"\n",(0,n.jsx)(t.p,{children:"In a CI pipeline, each shard can run as a separate job, making use of the hardware resources available in your CI pipeline, like CPU cores, to run tests faster."}),"\n",(0,n.jsx)(t.h2,{id:"sharding-tests-between-multiple-machines",children:"Sharding tests between multiple machines"}),"\n",(0,n.jsxs)(t.p,{children:["To shard the test suite, pass ",(0,n.jsx)(t.code,{children:"--shard=x/y"})," to the command line. For example, to split the suite into four shards, each running one fourth of the tests:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"npx playwright test --shard=1/4\nnpx playwright test --shard=2/4\nnpx playwright test --shard=3/4\nnpx playwright test --shard=4/4\n"})}),"\n",(0,n.jsx)(t.p,{children:"Now, if you run these shards in parallel on different jobs, your test suite completes four times faster."}),"\n",(0,n.jsxs)(t.p,{children:["Note that Playwright can only shard tests that can be run in parallel. By default, this means Playwright will shard test files. Learn about other options in the ",(0,n.jsx)(t.a,{href:"/docs/next/test-parallel",children:"parallelism guide"}),"."]}),"\n",(0,n.jsx)(t.h2,{id:"merging-reports-from-multiple-shards",children:"Merging reports from multiple shards"}),"\n",(0,n.jsx)(t.p,{children:"In the previous example, each test shard has its own test report. If you want to have a combined report showing all the test results from all the shards, you can merge them."}),"\n",(0,n.jsxs)(t.p,{children:["Start with adding ",(0,n.jsx)(t.code,{children:"blob"})," reporter to the config when running on CI:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",metastring:'title="playwright.config.ts"',children:"export default defineConfig({\n  testDir: './tests',\n  reporter: process.env.CI ? 'blob' : 'html',\n});\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Blob report contains information about all the tests that were run and their results as well as all test attachments such as traces and screenshot diffs. Blob reports can be merged and converted to any other Playwright report. By default, blob report will be generated into ",(0,n.jsx)(t.code,{children:"blob-report"})," directory."]}),"\n",(0,n.jsxs)(t.p,{children:["To merge reports from multiple shards, put the blob report files into a single directory, for example ",(0,n.jsx)(t.code,{children:"all-blob-reports"}),". Blob report names contain shard number, so they will not clash."]}),"\n",(0,n.jsxs)(t.p,{children:["Afterwards, run ",(0,n.jsx)(t.code,{children:"npx playwright merge-reports"})," command:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"npx playwright merge-reports --reporter html ./all-blob-reports\n"})}),"\n",(0,n.jsxs)(t.p,{children:["This will produce a standard HTML report into ",(0,n.jsx)(t.code,{children:"playwright-report"})," directory."]}),"\n",(0,n.jsx)(t.h2,{id:"github-actions-example",children:"GitHub Actions example"}),"\n",(0,n.jsxs)(t.p,{children:["GitHub Actions supports ",(0,n.jsx)(t.a,{href:"https://docs.github.com/en/actions/using-jobs/using-a-matrix-for-your-jobs",children:"sharding tests between multiple jobs"})," using the ",(0,n.jsx)(t.a,{href:"https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix",children:(0,n.jsx)(t.code,{children:"jobs.<job_id>.strategy.matrix"})})," option. The ",(0,n.jsx)(t.code,{children:"matrix"})," option will run a separate job for every possible combination of the provided options."]}),"\n",(0,n.jsxs)(t.p,{children:["The following example shows you how to configure a job to run your tests on four machines in parallel and then merge the reports into a single report. Don't forget to add ",(0,n.jsx)(t.code,{children:"reporter: process.env.CI ? 'blob' : 'html',"})," to your ",(0,n.jsx)(t.code,{children:"playwright.config.ts"})," file as in the example above."]}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:["First we add a ",(0,n.jsx)(t.code,{children:"matrix"})," option to our job configuration with the ",(0,n.jsx)(t.code,{children:"shardTotal: [4]"})," option containing the total number of shards we want to create and ",(0,n.jsx)(t.code,{children:"shardIndex: [1, 2, 3, 4]"})," with an array of the shard numbers."]}),"\n",(0,n.jsxs)(t.li,{children:["Then we run our Playwright tests with the ",(0,n.jsx)(t.code,{children:"--shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}"})," option. This will run our test command for each shard."]}),"\n",(0,n.jsx)(t.li,{children:"Finally we upload our blob report to the GitHub Actions Artifacts. This will make the blob report available to other jobs in the workflow."}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'title=".github/workflows/playwright.yml"',children:"name: Playwright Tests\non:\n  push:\n    branches: [ main, master ]\n  pull_request:\n    branches: [ main, master ]\njobs:\n  playwright-tests:\n    timeout-minutes: 60\n    runs-on: ubuntu-latest\n    strategy:\n      fail-fast: false\n      matrix:\n        shardIndex: [1, 2, 3, 4]\n        shardTotal: [4]\n    steps:\n    - uses: actions/checkout@v4\n    - uses: actions/setup-node@v4\n      with:\n        node-version: 18\n    - name: Install dependencies\n      run: npm ci\n    - name: Install Playwright browsers\n      run: npx playwright install --with-deps\n\n    - name: Run Playwright tests\n      run: npx playwright test --shard=${{ matrix.shardIndex }}/${{ matrix.shardTotal }}\n\n    - name: Upload blob report to GitHub Actions Artifacts\n      if: ${{ !cancelled() }}\n      uses: actions/upload-artifact@v4\n      with:\n        name: blob-report-${{ matrix.shardIndex }}\n        path: blob-report\n        retention-days: 1\n"})}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:["After all shards have completed, you can run a separate job that will merge the reports and produce a combined ",(0,n.jsx)(t.a,{href:"/docs/next/test-reporters#html-reporter",children:"HTML report"}),". To ensure the execution order, we make the ",(0,n.jsx)(t.code,{children:"merge-reports"})," job ",(0,n.jsx)(t.a,{href:"https://docs.github.com/en/actions/using-jobs/using-jobs-in-a-workflow#defining-prerequisite-jobs",children:"depend"})," on our sharded ",(0,n.jsx)(t.code,{children:"playwright-tests"})," job by adding ",(0,n.jsx)(t.code,{children:"needs: [playwright-tests]"}),"."]}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-yaml",metastring:'title=".github/workflows/playwright.yml"',children:"jobs:\n...\n  merge-reports:\n    # Merge reports after playwright-tests, even if some shards have failed\n    if: ${{ !cancelled() }}\n    needs: [playwright-tests]\n\n    runs-on: ubuntu-latest\n    steps:\n    - uses: actions/checkout@v4\n    - uses: actions/setup-node@v4\n      with:\n        node-version: 18\n    - name: Install dependencies\n      run: npm ci\n\n    - name: Download blob reports from GitHub Actions Artifacts\n      uses: actions/download-artifact@v4\n      with:\n        path: all-blob-reports\n        pattern: blob-report-*\n        merge-multiple: true\n\n    - name: Merge into HTML Report\n      run: npx playwright merge-reports --reporter html ./all-blob-reports\n\n    - name: Upload HTML report\n      uses: actions/upload-artifact@v4\n      with:\n        name: html-report--attempt-${{ github.run_attempt }}\n        path: playwright-report\n        retention-days: 14\n"})}),"\n",(0,n.jsx)(t.p,{children:"You can now see the reports have been merged and a combined HTML report is available in the GitHub Actions Artifacts tab."}),"\n",(0,n.jsx)("img",{width:"875",alt:"image",src:"https://github.com/microsoft/playwright/assets/9798949/b69dac59-fc19-4b98-8f49-814b1c29ca02"}),"\n",(0,n.jsx)(t.h2,{id:"merge-reports-cli",children:"Merge-reports CLI"}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"npx playwright merge-reports path/to/blob-reports-dir"})," reads all blob reports from the passed directory and merges them into a single report."]}),"\n",(0,n.jsx)(t.p,{children:"When merging reports from different OS'es you'll have to provide an explicit merge config to disambiguate which directory should be used as tests root."}),"\n",(0,n.jsx)(t.p,{children:"Supported options:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.code,{children:"--reporter reporter-to-use"})}),"\n",(0,n.jsx)(t.p,{children:"Which report to produce. Can be multiple reporters separated by comma."}),"\n",(0,n.jsx)(t.p,{children:"Example:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"npx playwright merge-reports --reporter=html,github ./blob-reports\n"})}),"\n"]}),"\n",(0,n.jsxs)(t.li,{children:["\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.code,{children:"--config path/to/config/file"})}),"\n",(0,n.jsx)(t.p,{children:"Specifies the Playwright configuration file with output reporters. Use this option to pass additional configuration to the output reporter. This configuration file can differ from the one used during the creation of blob reports."}),"\n",(0,n.jsx)(t.p,{children:"Example:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"npx playwright merge-reports --config=merge.config.ts ./blob-reports\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-ts",metastring:'title="merge.config.ts"',children:"export default {\n  testDir: 'e2e',\n  reporter: [['html', { open: 'never' }]],\n};\n"})}),"\n"]}),"\n"]})]})}function c(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}}}]);